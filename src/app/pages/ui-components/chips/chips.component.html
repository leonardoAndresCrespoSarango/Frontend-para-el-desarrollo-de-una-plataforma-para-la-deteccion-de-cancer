<div>
  <button mat-button (click)="addPatient()">Agregar Paciente</button>
</div>

<mat-form-field appearance="outline" style="width: 100%; margin-bottom: 20px;">
  <mat-label>Buscar paciente</mat-label>
  <input
    matInput
    placeholder="Ingresa un término de búsqueda"
    [(ngModel)]="searchTerm"
    (ngModelChange)="applyFilter()"
  />
  <mat-icon matSuffix color="accent">search</mat-icon>
  <mat-icon matSuffix (click)="searchTerm = ''; applyFilter()">clear</mat-icon>
</mat-form-field>

<div *ngIf="patients.length === 0" class="no-patients">
  <p>No se encontraron pacientes.</p>
</div>

<div *ngIf="patients.length > 0">
  <h2>Pacientes</h2>
  <table class="styled-table">
    <thead>
    <tr>
      <th>Cédula del Paciente</th>
      <th>Número de Historia Clínica</th>
      <th style="text-align: center">Médico</th>
      <th style="text-align: center">IA</th>
      <th>Concordancia</th>
      <th>Encuesta</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let patient of filteredPatients">
      <td>{{ patient.patient_id }}</td>
      <td>{{ patient.numero_historia_clinica }}</td>
      <td>
        <div style="display: flex; align-items: center;">
          <div style="text-align: center; margin-right: 10px;">
            <!--[disabled]="patient.diagnosticStatus === 'Generado'"-->
            <button mat-button (click)="addDiagnostic(patient)">Diagnóstico Médico</button>
            <small
              [ngClass]="{
                  'status-generated': patient.diagnosticStatus === 'Generado',
                  'status-not-generated': patient.diagnosticStatus === 'No generado'
                }"
              style="display: block; font-size: 10px;"
            >
              {{ patient.diagnosticStatus }}
            </small>
          </div>
          <!-- Botón para visualizar reporte -->
          <div style="text-align: center;">
            <img
              src="assets/images/logos/lookPDF.png"
              alt="Ver Reporte"
              class="report-icon"
              [ngClass]="{ 'disabled': !patient.report_path }"
              (click)="viewReport(patient.report_path)"
              [title]="!patient.report_path ? 'Reporte no disponible' : 'Ver Reporte PDF'"
            />
          </div>

        </div>
      </td>
      <td>
        <div style="text-align: center;">
          <button mat-button class="btn-diagnostico-ia" (click)="onGenerateIA(patient.patient_id)">Prediagnóstico IA</button>
          <small style="display: block; font-size: 10px;">{{ patient.iaStatus || 'No generado' }}</small>
        </div>
      </td>
      <td>
        <div class="traffic-light small">
          <div class="protector"></div>
          <div class="protector"></div>
          <div class="protector"></div>
          <div
            class="light-red"
            [ngClass]="{ 'active': !patient.is_generated }">
          </div>
          <div
            class="light-yellow"
            [ngClass]="{ 'active': patient.is_generated && !patient.has_cancer }">
          </div>
          <div
            class="light-green"
            [ngClass]="{ 'active': patient.is_generated && patient.has_cancer }">
          </div>
        </div>
        <div class="traffic-description">
          <strong>{{ getStatusDescription(patient) }}</strong>
        </div>
      </td>
      <td>
        <div style="text-align: center;">
          <button mat-button class="btn-diagnostico-ia" (click)="addSegmentacion(patient)">Segmentacion</button>
        </div>
      </td>




      <td>
        <button
          mat-button
          class="btnSurvey"
          (click)="openSurveyDialog(patient)"
          style="display: flex; justify-content: center; align-items: center; padding: 0;">
          <img class="imgbtn" src="assets/images/logos/encuesta1.png" alt="Encuesta" />
        </button>

        <!-- Mostrar mensaje según el estado de la encuesta -->
        <small
          *ngIf="!patient.survey_completed"
          class="survey-completedF-message"
          style="display: block; font-size: 10px;">
          Pendiente
        </small>
        <small
          *ngIf="patient.survey_completed"
          class="survey-completedT-message"
          style=" display: block; font-size: 10px;">
          Realizada
        </small>
      </td>
    </tr>
    </tbody>
  </table>
</div>
