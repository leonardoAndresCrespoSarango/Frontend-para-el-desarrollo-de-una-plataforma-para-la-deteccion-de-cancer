<div>
  <button mat-button (click)="addPatient()">Agregar Paciente</button>
</div>

<mat-form-field appearance="outline" style="width: 100%; margin-bottom: 20px;">
  <mat-label>Buscar paciente</mat-label>
  <input
    matInput
    placeholder="Ingresa un término de búsqueda"
    [(ngModel)]="searchTerm"
    (ngModelChange)="applyFilter()"
  />
  <mat-icon matSuffix color="accent">search</mat-icon>
  <mat-icon matSuffix (click)="searchTerm = ''; applyFilter()">clear</mat-icon>
</mat-form-field>

<div *ngIf="patients.length === 0" class="no-patients">
  <p>No se encontraron pacientes.</p>
</div>

<div *ngIf="patients.length > 0">
  <h2>Pacientes</h2>
  <table class="styled-table">
    <thead>
    <tr>
      <th>Cédula del Paciente</th>
      <th>Número de Historia Clínica</th>
      <th>Fase</th>
      <th>Titulo</th>
      <th>Encuesta</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let patient of filteredPatients">
      <td>{{ patient.patient_id }}</td>
      <td>{{ patient.numero_historia_clinica }}</td>
      <td>
        <div style="display: flex; align-items: center;">
          <div style="text-align: center; margin-right: 10px;">
            <button mat-button [disabled]="patient.diagnosticStatus === 'Generado'" (click)="addDiagnostic(patient)">Diagnóstico Médico</button>
            <small
              [ngClass]="{
                  'status-generated': patient.diagnosticStatus === 'Generado',
                  'status-not-generated': patient.diagnosticStatus === 'No generado'
                }"
              style="display: block; font-size: 10px;"
            >
              {{ patient.diagnosticStatus }}
            </small>
          </div>
          <div style="text-align: center;">
            <button mat-button class="btn-diagnostico-ia" (click)="onGenerateIA(patient.patient_id)">Generar Diagnóstico IA</button>
            <small style="display: block; font-size: 10px;">{{ patient.iaStatus || 'No generado' }}</small>
          </div>
        </div>
      </td>
      <td>
        <div style="display: flex; align-items: center;">
          <div class="traffic-light-container">
            <div class="traffic-light">
              <!-- Clase activa según el estado o rojo por defecto -->
              <div class="light green" [class.active]="patient.status === 'ok'"></div>
              <div class="light yellow" [class.active]="patient.status === 'pending'"></div>
              <div class="light red" [class.active]="!patient.status || patient.status === 'critical'"></div>
            </div>
          </div>
          <div style="margin-left: 15px;">
            <strong>{{ getStatusLabel(patient.status || 'critical') }}</strong>
          </div>
        </div>
      </td>
      <td>
        <button mat-button class="btnSurvey" (click)="openSurveyDialog(patient)" [disabled]="patient.survey_completed">
          <img src="assets/images/logos/encuesta1.png" alt="Encuesta" class="button-icon"/>
        </button>
        <!-- Mostrar mensaje cuando el botón esté deshabilitado -->
        <small *ngIf="patient.survey_completed" class="survey-completed-message">
          Encuesta realizada
        </small>
      </td>
    </tr>
    </tbody>
  </table>
</div>
